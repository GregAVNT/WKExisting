/* global tinymce *//**
 * WordPress View plugin.
 */(function(){var e=tinymce.VK,t=tinymce.dom.TreeWalker,n;tinymce.create("tinymce.plugins.wpView",{init:function(r){var i=this;if(typeof wp=="undefined"||!wp.mce)return;r.onPreInit.add(function(e){e.schema.addValidElements("div[*],span[*]")});r.onBeforeSetContent.add(function(e,t){if(!t.content)return;t.content=wp.mce.view.toViews(t.content)});r.onSetContent.add(function(e){wp.mce.view.render(e.getDoc())});r.onInit.add(function(e){e.selection.onBeforeSetContent.add(function(n){var r=i.getParentView(n.getNode()),s,o;if(!r)return;if(!r.nextSibling||i.isView(r.nextSibling)){o=e.getDoc().createTextNode("");e.dom.insertAfter(o,r)}else{s=new t(r.nextSibling,r.nextSibling);o=s.next()}n.select(o);n.collapse(!0)});e.selection.onSetContent.add(function(e,t){if(!t.context)return;var n=e.getNode();if(!n.innerHTML)return;n.innerHTML=wp.mce.view.toViews(n.innerHTML);wp.mce.view.render(n)})});r.onPostProcess.add(function(e,t){if(!t.get&&!t.save||!t.content)return;t.content=wp.mce.view.toText(t.content)});r.onNodeChange.addToTop(function(e,t,n){var r=i.getParentView(n);if(r){i.select(r);return!1}i.deselect()});r.onKeyDown.addToTop(function(t,r){var s=r.keyCode,o,u;if(!n)return;o=i.getParentView(t.selection.getNode());if(o!==n){i.deselect();return}if(s===e.DELETE||s===e.BACKSPACE)if(u=wp.mce.view.instance(n)){u.remove();i.deselect()}if(r.metaKey||r.ctrlKey||s>=112&&s<=123)return;r.preventDefault()})},getParentView:function(e){while(e){if(this.isView(e))return e;e=e.parentNode}},isView:function(e){return/(?:^|\s)wp-view-wrap(?:\s|$)/.test(e.className)},select:function(e){if(e===n)return;this.deselect();n=e;wp.mce.view.select(n)},deselect:function(){n&&wp.mce.view.deselect(n);n=null},getInfo:function(){return{longname:"WordPress Views",author:"WordPress",authorurl:"http://wordpress.org",infourl:"http://wordpress.org",version:"1.0"}}});tinymce.PluginManager.add("wpview",tinymce.plugins.wpView)})();